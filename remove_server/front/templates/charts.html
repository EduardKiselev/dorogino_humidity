<script>
// –û—Ç–ª–∞–¥–∫–∞: –ø—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≥—Ä—É–∑–∫—É –±–∏–±–ª–∏–æ—Ç–µ–∫
console.log('‚úÖ Chart.js –∑–∞–≥—Ä—É–∂–µ–Ω:', typeof Chart !== 'undefined');

// –•—Ä–∞–Ω–∏–º –≤—Å–µ –≥—Ä–∞—Ñ–∏–∫–∏ –¥–ª—è –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏
const charts = {};

// –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ —Å–µ–Ω—Å–æ—Ä–∞–º
function groupBySensor(data) {
    const grouped = {};
    data.forEach(item => {
        if (!grouped[item.sensor_id]) {
            grouped[item.sensor_id] = [];
        }
        grouped[item.sensor_id].push(item);
    });
    return grouped;
}

// –°–æ–∑–¥–∞—ë–º –≥—Ä–∞—Ñ–∏–∫ —Å –¥–≤—É–º—è –æ—Å—è–º–∏ Y
function createDualAxisChart(canvasId, data, timeUnit = 'hour') {
    const canvas = document.getElementById(canvasId);
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞
    if (!canvas) {
        console.warn(`‚ö†Ô∏è Canvas –Ω–µ –Ω–∞–π–¥–µ–Ω: #${canvasId}`);
        return null;
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    if (!data || data.length === 0) {
        console.warn(`‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ ${canvasId}`);
        return null;
    }
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞—Ç
    const invalidDates = data.filter(d => isNaN(new Date(d.timestamp).getTime()));
    if (invalidDates.length > 0) {
        console.error(`‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞—Ç—ã –≤ ${canvasId}:`, invalidDates.slice(0, 3));
        return null;
    }
    
    const ctx = canvas.getContext('2d');
    
    try {
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.map(d => new Date(d.timestamp)),
                datasets: [
                    {
                        label: '–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (¬∞C)',
                        data: data.map(d => d.temperature),
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        borderWidth: 2,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        tension: 0.3,
                        yAxisID: 'yTemp'
                    },
                    {
                        label: '–í–ª–∞–∂–Ω–æ—Å—Ç—å (%)',
                        data: data.map(d => d.humidity),
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        borderWidth: 2,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        tension: 0.3,
                        yAxisID: 'yHum'
                    }
                ]
            },
            options: {
                animation: false,  // ‚Üê –û—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: { 
                            unit: timeUnit,
                            tooltipFormat: 'dd.MM.yyyy HH:mm'
                        },
                        title: { 
                            display: true, 
                            text: '–í—Ä–µ–º—è' 
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        },
                        ticks: {
                            maxTicksLimit: 10
                        }
                    },
                    yTemp: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: { 
                            display: true, 
                            text: '–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (¬∞C)' 
                        },
                        grid: { 
                            drawOnChartArea: false 
                        },
                        ticks: {
                            color: 'rgb(255, 99, 132)',
                            // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–ª—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã
                            suggestedMin: -5,
                            suggestedMax: 40
                        }
                    },
                    yHum: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: { 
                            display: true, 
                            text: '–í–ª–∞–∂–Ω–æ—Å—Ç—å (%)' 
                        },
                        grid: { 
                            drawOnChartArea: false 
                        },
                        ticks: {
                            color: 'rgb(54, 162, 235)',
                            // –í–ª–∞–∂–Ω–æ—Å—Ç—å: –æ—Ç 0 –¥–æ 100%
                            min: 0,
                            max: 100,
                            stepSize: 10
                        }
                    }
                }
            }
        });
        
        console.log(`‚úÖ –ì—Ä–∞—Ñ–∏–∫ —Å–æ–∑–¥–∞–Ω: ${canvasId}`);
        return chart;
        
    } catch (error) {
        console.error(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞ ${canvasId}:`, error);
        return null;
    }
}

// –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ —Å–µ–Ω—Å–æ—Ä–∞–º
const dayDataBySensor = groupBySensor({{ day_data|tojson }});
const monthDataBySensor = groupBySensor({{ month_data|tojson }});
const yearDataBySensor = groupBySensor({{ year_data|tojson }});

// –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–ª–∞–¥–æ—á–Ω—ã–π –≤—ã–≤–æ–¥ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö
console.log("üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ —Å–µ–Ω—Å–æ—Ä–∞–º:");
console.log("üìä –î–∞–Ω–Ω—ã–µ –∑–∞ –¥–µ–Ω—å –ø–æ —Å–µ–Ω—Å–æ—Ä–∞–º:", dayDataBySensor);
console.log("üìä –î–∞–Ω–Ω—ã–µ –∑–∞ –º–µ—Å—è—Ü –ø–æ —Å–µ–Ω—Å–æ—Ä–∞–º:", monthDataBySensor);
console.log("üìä –î–∞–Ω–Ω—ã–µ –∑–∞ –≥–æ–¥ –ø–æ —Å–µ–Ω—Å–æ—Ä–∞–º:", yearDataBySensor);

// –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–µ–Ω—Å–æ—Ä–∞
Object.keys(dayDataBySensor).forEach(sensorId => {
    console.log(`üìä –°–µ–Ω—Å–æ—Ä ${sensorId}: ${dayDataBySensor[sensorId].length} –∑–∞–ø–∏—Å–µ–π –∑–∞ –¥–µ–Ω—å`);
});
Object.keys(monthDataBySensor).forEach(sensorId => {
    console.log(`üìä –°–µ–Ω—Å–æ—Ä ${sensorId}: ${monthDataBySensor[sensorId].length} –∑–∞–ø–∏—Å–µ–π –∑–∞ –º–µ—Å—è—Ü`);
});
Object.keys(yearDataBySensor).forEach(sensorId => {
    console.log(`üìä –°–µ–Ω—Å–æ—Ä ${sensorId}: ${yearDataBySensor[sensorId].length} –∑–∞–ø–∏—Å–µ–π –∑–∞ –≥–æ–¥`);
});

// –°–æ–∑–¥–∞—ë–º –≥—Ä–∞—Ñ–∏–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–µ–Ω—Å–æ—Ä–∞
{% for sensor_id in sensor_ids %}
    const sensorId = {{ sensor_id }};
    
    // –ì—Ä–∞—Ñ–∏–∫ –∑–∞ –¥–µ–Ω—å
    if (dayDataBySensor[sensorId] && dayDataBySensor[sensorId].length > 0) {
        charts[`chart-day-${sensorId}`] = createDualAxisChart(
            `chart-day-${sensorId}`, 
            dayDataBySensor[sensorId], 
            'hour'
        );
    } else {
        console.log(`‚ÑπÔ∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –¥–µ–Ω—å –¥–ª—è —Å–µ–Ω—Å–æ—Ä–∞ ${sensorId}`);
    }
    
    // –ì—Ä–∞—Ñ–∏–∫ –∑–∞ –º–µ—Å—è—Ü
    if (monthDataBySensor[sensorId] && monthDataBySensor[sensorId].length > 0) {
        charts[`chart-month-${sensorId}`] = createDualAxisChart(
            `chart-month-${sensorId}`, 
            monthDataBySensor[sensorId], 
            'day'
        );
    } else {
        console.log(`‚ÑπÔ∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –º–µ—Å—è—Ü –¥–ª—è —Å–µ–Ω—Å–æ—Ä–∞ ${sensorId}`);
    }
    
    // –ì—Ä–∞—Ñ–∏–∫ –∑–∞ –≥–æ–¥
    if (yearDataBySensor[sensorId] && yearDataBySensor[sensorId].length > 0) {
        charts[`chart-year-${sensorId}`] = createDualAxisChart(
            `chart-year-${sensorId}`, 
            yearDataBySensor[sensorId], 
            'month'
        );
    } else {
        console.log(`‚ÑπÔ∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≥–æ–¥ –¥–ª—è —Å–µ–Ω—Å–æ—Ä–∞ ${sensorId}`);
    }
{% endfor %}


console.log('üìä –í—Å–µ–≥–æ –≥—Ä–∞—Ñ–∏–∫–æ–≤ —Å–æ–∑–¥–∞–Ω–æ:', Object.keys(charts).length);
