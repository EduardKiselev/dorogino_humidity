{% extends "base.html" %}

{% block title %}–ì—Ä–∞—Ñ–∏–∫–∏{% endblock %}

{% block content %}
<h2>üìà –ì—Ä–∞—Ñ–∏–∫–∏ –ø–æ–∫–∞–∑–∞–Ω–∏–π</h2>

<!-- –í–∫–ª–∞–¥–∫–∏ –ø–æ —Å–µ–Ω—Å–æ—Ä–∞–º -->
<ul class="nav nav-tabs mb-3" role="tablist" id="sensorTabs">
    {% for sensor_id in sensor_ids %}
    <li class="nav-item" role="presentation">
        <button class="nav-link {% if loop.first %}active{% endif %}" 
                data-bs-toggle="tab" 
                data-bs-target="#sensor-{{ sensor_id }}">
            –°–µ–Ω—Å–æ—Ä {{ sensor_id }}
        </button>
    </li>
    {% endfor %}
</ul>

<div class="tab-content" id="sensorTabContent">
    {% for sensor_id in sensor_ids %}
    <div class="tab-pane fade {% if loop.first %}show active{% endif %}" id="sensor-{{ sensor_id }}">
        <div class="row">
            <!-- –ó–∞ –¥–µ–Ω—å -->
            <div class="col-md-12 mb-3">
                <h5>–ó–∞ –¥–µ–Ω—å</h5>
                <canvas id="chart-day-{{ sensor_id }}" height="100"></canvas>
            </div>
            
            <!-- –ó–∞ –º–µ—Å—è—Ü -->
            <div class="col-md-12 mb-3">
                <h5>–ó–∞ –º–µ—Å—è—Ü</h5>
                <canvas id="chart-month-{{ sensor_id }}" height="100"></canvas>
            </div>
            
            <!-- –ó–∞ –≥–æ–¥ -->
            <div class="col-md-12 mb-3">
                <h5>–ó–∞ –≥–æ–¥</h5>
                <canvas id="chart-year-{{ sensor_id }}" height="100"></canvas>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

{% endblock %}

{% block extra_js %}

<script src="https://cdn.jsdelivr.net/npm/date-fns@2.30.0/index.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ —Å–µ–Ω—Å–æ—Ä–∞–º
function groupBySensor(data) {
    const grouped = {};
    data.forEach(item => {
        if (!grouped[item.sensor_id]) {
            grouped[item.sensor_id] = [];
        }
        grouped[item.sensor_id].push(item);
    });
    return grouped;
}

// –°–æ–∑–¥–∞—ë–º –≥—Ä–∞—Ñ–∏–∫ —Å –¥–≤—É–º—è –æ—Å—è–º–∏ Y
function createDualAxisChart(canvasId, data, timeUnit = 'hour') {
    const ctx = document.getElementById(canvasId).getContext('2d');
    
    return new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.map(d => new Date(d.timestamp)),
            datasets: [
                {
                    label: '–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (¬∞C)',
                    data: data.map(d => d.temperature),
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    tension: 0.3,
                    yAxisID: 'yTemp'
                },
                {
                    label: '–í–ª–∞–∂–Ω–æ—Å—Ç—å (%)',
                    data: data.map(d => d.humidity),
                    borderColor: 'rgb(54, 162, 235)',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    tension: 0.3,
                    yAxisID: 'yHum'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    type: 'time',
                    time: { unit: timeUnit },
                    title: { display: true, text: '–í—Ä–µ–º—è' }
                },
                yTemp: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: { display: true, text: '–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (¬∞C)' },
                    grid: { drawOnChartArea: false }
                },
                yHum: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: { display: true, text: '–í–ª–∞–∂–Ω–æ—Å—Ç—å (%)' },
                    grid: { drawOnChartArea: false },
                    min: 0,
                    max: 100
                }
            }
        }
    });
}

// –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ —Å–µ–Ω—Å–æ—Ä–∞–º
const dayDataBySensor = groupBySensor({{ day_data|tojson }});
const monthDataBySensor = groupBySensor({{ month_data|tojson }});
const yearDataBySensor = groupBySensor({{ year_data|tojson }});

// –°–æ–∑–¥–∞—ë–º –≥—Ä–∞—Ñ–∏–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–µ–Ω—Å–æ—Ä–∞
{% for sensor_id in sensor_ids %}
    const sensorId = {{ sensor_id }};
    
    if (dayDataBySensor[sensorId] && dayDataBySensor[sensorId].length > 0) {
        createDualAxisChart('chart-day-' + sensorId, dayDataBySensor[sensorId], 'hour');
    }
    
    if (monthDataBySensor[sensorId] && monthDataBySensor[sensorId].length > 0) {
        createDualAxisChart('chart-month-' + sensorId, monthDataBySensor[sensorId], 'day');
    }
    
    if (yearDataBySensor[sensorId] && yearDataBySensor[sensorId].length > 0) {
        createDualAxisChart('chart-year-' + sensorId, yearDataBySensor[sensorId], 'month');
    }
{% endfor %}
</script>
{% endblock %}