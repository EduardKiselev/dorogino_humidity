{% extends "base.html" %}

{% block title %}–ì—Ä–∞—Ñ–∏–∫–∏{% endblock %}

{% block content %}
<h2>üìà –ì—Ä–∞—Ñ–∏–∫–∏ –ø–æ–∫–∞–∑–∞–Ω–∏–π</h2>

<!-- –í–∫–ª–∞–¥–∫–∏ –ø–æ —Å–µ–Ω—Å–æ—Ä–∞–º -->
<ul class="nav nav-tabs mb-3" role="tablist" id="sensorTabs">
    {% for sensor_id in sensor_ids %}
    <li class="nav-item" role="presentation">
        <button class="nav-link {% if loop.first %}active{% endif %}" 
                data-bs-toggle="tab" 
                data-bs-target="#sensor-{{ sensor_id }}">
            –°–µ–Ω—Å–æ—Ä {{ sensor_id }}
        </button>
    </li>
    {% endfor %}
</ul>

<div class="tab-content" id="sensorTabContent">
    {% for sensor_id in sensor_ids %}
    <div class="tab-pane fade {% if loop.first %}show active{% endif %}" id="sensor-{{ sensor_id }}">
        <div class="row">
            <!-- –ó–∞ –¥–µ–Ω—å -->
            <div class="col-md-12 mb-3">
                <h5>–ó–∞ –¥–µ–Ω—å</h5>
                <div style="height: 250px; position: relative;">
                    <canvas id="chart-day-{{ sensor_id }}"></canvas>
                </div>
            </div>
            
            <!-- –ó–∞ –º–µ—Å—è—Ü -->
            <div class="col-md-12 mb-3">
                <h5>–ó–∞ –º–µ—Å—è—Ü</h5>
                <div style="height: 250px; position: relative;">
                    <canvas id="chart-month-{{ sensor_id }}"></canvas>
                </div>
            </div>
            
            <!-- –ó–∞ –≥–æ–¥ -->
            <div class="col-md-12 mb-3">
                <h5>–ó–∞ –≥–æ–¥</h5>
                <div style="height: 250px; position: relative;">
                    <canvas id="chart-year-{{ sensor_id }}"></canvas>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

{% endblock %}

{% block extra_js %}

<!-- –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: —Å–Ω–∞—á–∞–ª–∞ Chart.js, –ø–æ—Ç–æ–º –∞–¥–∞–ø—Ç–µ—Ä—ã -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/date-fns@2.30.0/index.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

<script>
// –û—Ç–ª–∞–¥–∫–∞: –ø—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≥—Ä—É–∑–∫—É –±–∏–±–ª–∏–æ—Ç–µ–∫
console.log('‚úÖ Chart.js –∑–∞–≥—Ä—É–∂–µ–Ω:', typeof Chart !== 'undefined');

// –•—Ä–∞–Ω–∏–º –≤—Å–µ –≥—Ä–∞—Ñ–∏–∫–∏ –¥–ª—è –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏
const charts = {};

// –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ —Å–µ–Ω—Å–æ—Ä–∞–º
function groupBySensor(data) {
    const grouped = {};
    data.forEach(item => {
        if (!grouped[item.sensor_id]) {
            grouped[item.sensor_id] = [];
        }
        grouped[item.sensor_id].push(item);
    });
    return grouped;
}

// –°–æ–∑–¥–∞—ë–º –≥—Ä–∞—Ñ–∏–∫ —Å –¥–≤—É–º—è –æ—Å—è–º–∏ Y
function createDualAxisChart(canvasId, data, timeUnit = 'hour') {
    const canvas = document.getElementById(canvasId);
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞
    if (!canvas) {
        console.warn(`‚ö†Ô∏è Canvas –Ω–µ –Ω–∞–π–¥–µ–Ω: #${canvasId}`);
        return null;
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    if (!data || data.length === 0) {
        console.warn(`‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ ${canvasId}`);
        return null;
    }
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞—Ç
    const invalidDates = data.filter(d => isNaN(new Date(d.timestamp).getTime()));
    if (invalidDates.length > 0) {
        console.error(`‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞—Ç—ã –≤ ${canvasId}:`, invalidDates.slice(0, 3));
        return null;
    }
    
    const ctx = canvas.getContext('2d');
    
    try {
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.map(d => new Date(d.timestamp)),
                datasets: [
                    {
                        label: '–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (¬∞C)',
                        data: data.map(d => d.temperature),
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        borderWidth: 2,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        tension: 0.3,
                        yAxisID: 'yTemp'
                    },
                    {
                        label: '–í–ª–∞–∂–Ω–æ—Å—Ç—å (%)',
                        data: data.map(d => d.humidity),
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        borderWidth: 2,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        tension: 0.3,
                        yAxisID: 'yHum'
                    }
                ]
            },
            options: {
                animation: false,  // ‚Üê –û—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: { 
                            unit: timeUnit,
                            tooltipFormat: 'dd.MM.yyyy HH:mm'
                        },
                        title: { 
                            display: true, 
                            text: '–í—Ä–µ–º—è' 
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        },
                        ticks: {
                            maxTicksLimit: 10
                        }
                    },
                    yTemp: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: { 
                            display: true, 
                            text: '–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (¬∞C)' 
                        },
                        grid: { 
                            drawOnChartArea: false 
                        },
                        ticks: {
                            color: 'rgb(255, 99, 132)',
                            // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–ª—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã
                            suggestedMin: -5,
                            suggestedMax: 40
                        }
                    },
                    yHum: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: { 
                            display: true, 
                            text: '–í–ª–∞–∂–Ω–æ—Å—Ç—å (%)' 
                        },
                        grid: { 
                            drawOnChartArea: false 
                        },
                        ticks: {
                            color: 'rgb(54, 162, 235)',
                            // –í–ª–∞–∂–Ω–æ—Å—Ç—å: –æ—Ç 0 –¥–æ 100%
                            min: 0,
                            max: 100,
                            stepSize: 10
                        }
                    }
                }
            }
        });
        
        console.log(`‚úÖ –ì—Ä–∞—Ñ–∏–∫ —Å–æ–∑–¥–∞–Ω: ${canvasId}`);
        return chart;
        
    } catch (error) {
        console.error(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞ ${canvasId}:`, error);
        return null;
    }
}

// –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ —Å–µ–Ω—Å–æ—Ä–∞–º
const dayDataBySensor = groupBySensor({{ day_data|tojson }});
const monthDataBySensor = groupBySensor({{ month_data|tojson }});
const yearDataBySensor = groupBySensor({{ year_data|tojson }});

// –°–æ–∑–¥–∞—ë–º –≥—Ä–∞—Ñ–∏–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–µ–Ω—Å–æ—Ä–∞
{% for sensor_id in sensor_ids %}
    const sensorId = {{ sensor_id }};
    
    // –ì—Ä–∞—Ñ–∏–∫ –∑–∞ –¥–µ–Ω—å
    if (dayDataBySensor[sensorId] && dayDataBySensor[sensorId].length > 0) {
        charts[`chart-day-${sensorId}`] = createDualAxisChart(
            `chart-day-${sensorId}`, 
            dayDataBySensor[sensorId], 
            'hour'
        );
    } else {
        console.log(`‚ÑπÔ∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –¥–µ–Ω—å –¥–ª—è —Å–µ–Ω—Å–æ—Ä–∞ ${sensorId}`);
    }
    
    // –ì—Ä–∞—Ñ–∏–∫ –∑–∞ –º–µ—Å—è—Ü
    if (monthDataBySensor[sensorId] && monthDataBySensor[sensorId].length > 0) {
        charts[`chart-month-${sensorId}`] = createDualAxisChart(
            `chart-month-${sensorId}`, 
            monthDataBySensor[sensorId], 
            'day'
        );
    } else {
        console.log(`‚ÑπÔ∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –º–µ—Å—è—Ü –¥–ª—è —Å–µ–Ω—Å–æ—Ä–∞ ${sensorId}`);
    }
    
    // –ì—Ä–∞—Ñ–∏–∫ –∑–∞ –≥–æ–¥
    if (yearDataBySensor[sensorId] && yearDataBySensor[sensorId].length > 0) {
        charts[`chart-year-${sensorId}`] = createDualAxisChart(
            `chart-year-${sensorId}`, 
            yearDataBySensor[sensorId], 
            'month'
        );
    } else {
        console.log(`‚ÑπÔ∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≥–æ–¥ –¥–ª—è —Å–µ–Ω—Å–æ—Ä–∞ ${sensorId}`);
    }
{% endfor %}

// –ü–ï–†–ï–†–ò–°–û–í–ö–ê –ü–†–ò –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ò –í–ö–õ–ê–î–û–ö (–ó–ê–ö–û–ú–ú–ï–ù–¢–ò–†–û–í–ê–ù–ê)
/*
document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', (event) => {
            const targetId = event.target.getAttribute('data-bs-target');
            const sensorId = targetId.replace('#sensor-', '');
            
            ['day', 'month', 'year'].forEach(period => {
                const chartKey = `chart-${period}-${sensorId}`;
                if (charts[chartKey]) {
                    charts[chartKey].resize();
                    charts[chartKey].update();
                }
            });
        });
    });
});
*/

console.log('üìä –í—Å–µ–≥–æ –≥—Ä–∞—Ñ–∏–∫–æ–≤ —Å–æ–∑–¥–∞–Ω–æ:', Object.keys(charts).length);
</script>
{% endblock %}